import React, { useState, useEffect, useMemo } from 'react';
import { Calendar, CheckCircle, Circle, BookOpen, Coffee, Award, ChevronLeft, ChevronRight, AlertCircle, TrendingUp, List, PieChart, CheckSquare, XSquare, Cloud, Save } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc } from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const StudyPlanner = () => {
  // --- State Management ---
  const [currentDate, setCurrentDate] = useState(new Date(2026, 1, 10)); // Simulating Today is Feb 10
  const [selectedDate, setSelectedDate] = useState(new Date(2026, 1, 10));
  const [viewMonth, setViewMonth] = useState(new Date(2026, 1, 1)); 
  const [activeTab, setActiveTab] = useState('calendar'); // 'calendar' or 'dashboard'
  const [tasks, setTasks] = useState({}); // Stores all todo items keyed by date
  const [user, setUser] = useState(null); // Auth state
  const [isSaving, setIsSaving] = useState(false); // Visual indicator for saving

  const examDate = new Date(2026, 2, 28);

  // --- Auth & Data Synchronization ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;

    // Listen to Firestore
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_data', 'study_plan');
    const unsubscribe = onSnapshot(docRef, (snapshot) => {
      if (snapshot.exists()) {
        setTasks(snapshot.data().tasks);
      } else {
        // Initialize for new user
        const initialTasks = generateDetailedPlan();
        setDoc(docRef, { tasks: initialTasks });
        setTasks(initialTasks);
      }
    });

    return () => unsubscribe();
  }, [user]);

  const generateDetailedPlan = () => {
    const plan = {};
    
    const addTask = (date, text, type = 'normal') => {
      if (!plan[date]) plan[date] = [];
      plan[date].push({ id: Math.random().toString(36).substr(2, 9), text, completed: false, type });
    };

    const setRangeTasks = (startDay, endDay, month, taskList, type = 'normal') => {
      let taskIndex = 0;
      for (let d = startDay; d <= endDay; d++) {
        const dateKey = `2026-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dailyTasks = taskList[taskIndex % taskList.length];
        
        if (Array.isArray(dailyTasks)) {
            dailyTasks.forEach(t => addTask(dateKey, t, type));
        } else {
            addTask(dateKey, dailyTasks, type);
        }
        taskIndex++;
      }
    };

    // --- 1. 취약점 완파: 무역규범 (2/10 ~ 2/15) ---
    const lawsTasks = [
      ["대외무역법 목적 및 용어 정의 암기", "무역업 고유번호 부여 및 관리 체계 정리", "수출입 실적 인정 범위 확인 (간접수출 포함)"], 
      ["특정거래형태 종류별 정의 (위탁가공, 중계무역 등)", "외화획득용 원료/기재 수입 제도 이해", "전략물자 수출입 통제 시스템 흐름도 그리기"], 
      ["원산지 표시 대상 및 판정 기준 암기", "원산지 표시 위반 시 제재 조치 정리", "대외무역법 벌칙 조항 (5년/3년/1년) 구분"], 
      ["관세법: 관세 부과 4대 요건 (과세물건, 납세의무자 등)", "관세평가 1방법 ~ 6방법 핵심 키워드 정리", "납세 담보 제도 및 기간 암기"], 
      ["탄력관세 제도 (덤핑방지, 상계, 보복관세 등) 표 정리", "관세 감면 제도 (무조건/조건부) 구분하기", "분할납부 및 월별납부 제도 이해"], 
      ["관세 환급 특례법: 정액환급 vs 개별환급", "보세구역 종류 (지정/특허/종합) 및 특징", "수입통관 및 보세운송 절차 도식화"], 
    ];
    setRangeTasks(10, 15, 2, lawsTasks, 'weakness');

    // --- 2. 설 연휴 (2/16 ~ 2/18) ---
    const restTasks = [
        ["무역 용어집 가볍게 30분 읽기", "컨디션 조절 및 휴식"],
        ["무역 용어집 가볍게 30분 읽기", "가족들과 시간 보내기"],
        ["연휴 복귀 준비", "내일부터 시작될 결제 파트 목차 훑어보기"]
    ];
    setRangeTasks(16, 18, 2, restTasks, 'rest');

    // --- 3. 취약점 완파: 무역결제/외환 (2/19 ~ 2/22) ---
    const paymentTasks = [
        ["신용장(L/C) 기본 거래 흐름도 백지에 그리기", "신용장 독립성/추상성 원칙 판례 읽기", "주요 당사자(개설은행, 통지은행 등) 의무 정리"], 
        ["UCP 600 주요 조항 (제1조~제10조) 정독", "하자 있는 서류의 처리 및 승낙 거절 통지 절차", "양도 가능 신용장 vs 백투백 신용장 비교"], 
        ["추심결제(D/P, D/A) 차이점 및 리스크 분석", "송금 방식(T/T)과 O/A 방식의 비교", "팩토링 및 포페이팅 금융 기법 이해"], 
        ["외환 실무: 매도율/매입율 적용 기준 암기", "환율 계산 기출문제 20제 풀기 (오답 필수)", "선물환 거래 및 환리스크 관리 기법 기초"], 
    ];
    setRangeTasks(19, 22, 2, paymentTasks, 'weakness');

    // --- 4. 2교시 굳히기: 운송/계약 (2/23 ~ 2/28) ---
    const transportTasks = [
        ["Incoterms 2020: E, F 그룹 (EXW, FCA, FAS, FOB) 분기점", "FOB와 CIF의 위험/비용 이전 시점 차이 명확화"],
        ["Incoterms 2020: C, D 그룹 (CFR, CIF, DAP, DDP) 정리", "Incoterms 2020 주요 변경 사항 (DAT -> DPU 등)"],
        ["해상운송: 정기선 vs 부정기선 특징 비교", "선하증권(B/L)의 기능 3가지 및 종류 (Clean, Dirty 등)"],
        ["항공운송장(AWB)과 B/L의 차이점", "복합운송증권(FBL)의 책임 원칙", "컨테이너 운송 (FCL/LCL) 흐름 이해"],
        ["무역계약의 성립 요건 (청약과 승낙)", "비엔나 협약(CISG) 주요 내용 정리 (매도인/매수인 의무)", "계약 위반 시 구제 수단"],
        ["무역영어 빈출 표현 50개 암기", "무역 서신(Letter) 구조 파악하기", "2월 학습 내용 총정리 및 복습"]
    ];
    setRangeTasks(23, 28, 2, transportTasks, 'study');

    // --- 5. 삼일절 연휴 (3/1 ~ 3/2) ---
    const samilTasks = [
        ["3월 학습 계획 재점검", "충분한 수면 취하기"],
        ["가벼운 마음으로 기출 단어장 훑기", "컨디션 조절"]
    ];
    setRangeTasks(1, 2, 3, samilTasks, 'rest');

    // --- 6. 파트별 집중 문제 풀이 (3/3 ~ 3/8) ---
    const practiceTasks = [
        ["대외무역법/관세법 기출 변형 문제 30제", "틀린 문제 법령 원문 찾아보기"],
        ["신용장/추심 심화 문제 30제", "UCP 600 관련 조항 매칭하며 오답 정리"],
        ["환율 계산 고난도 문제 15제 도전", "외환 실무 이론 빈칸 채우기"],
        ["Incoterms 2020 사례형 문제 분석", "운송 서류 관련 문제 풀이"],
        ["무역계약/영어 파트 통합 문제 풀이", "CISG 관련 문제 집중 공략"],
        ["취약 파트(점수 가장 낮은 곳) 재복습", "일주일간 틀린 문제 다시 풀기"]
    ];
    setRangeTasks(3, 8, 3, practiceTasks, 'practice');

    // --- 7. 기출 무한 회독 (3/9 ~ 3/20) ---
    const examTasks = [];
    for(let i=1; i<=12; i++) {
        examTasks.push([
            `기출 ${Math.ceil(i/2)}회차 실전 풀이 (${i%2 !== 0 ? '1교시' : '2교시'})`, 
            "채점 및 점수 기록", 
            "오답 노트 작성: 틀린 이유 분석하기 (단순실수/개념부족)"
        ]);
    }
    setRangeTasks(9, 20, 3, examTasks, 'exam_prep');

    // --- 8. 파이널 리허설 (3/21 ~ 3/27) ---
    const finalTasks = [
        ["기출 오답노트 1회독 (법령 위주)", "관세법 숫자 암기 (기간, 세율 등)"],
        ["기출 오답노트 2회독 (결제/외환 위주)", "환율 계산 공식 최종 점검"],
        ["기출 오답노트 3회독 (운송/계약 위주)", "Incoterms 표 백지에 그려보기"],
        ["최근 3개년 기출 중 가장 많이 틀린 회차 다시 풀기", "시험장 시뮬레이션 (시간 관리)"],
        ["전 과목 핵심 요약집 속독 1회", "시험 준비물 챙기기 (수험표, 신분증 등)"],
        ["전 과목 핵심 요약집 속독 2회", "멘탈 관리 및 이미지 트레이닝"],
        ["가볍게 전체 내용 훑기", "일찍 잠자리에 들기"]
    ];
    setRangeTasks(21, 27, 3, finalTasks, 'final');

    addTask('2026-03-28', '시험장 입실 완료 (09:00까지)', 'dday');
    addTask('2026-03-28', '1교시 시험 응시 (09:30 ~ 11:00)', 'dday');
    addTask('2026-03-28', '2교시 시험 응시 (11:20 ~ 12:50)', 'dday');

    return plan;
  };

  // --- Logic Helpers ---
  const toggleTask = async (dateKey, taskId) => {
    if (!user) return;
    
    // 1. Optimistic Update
    const newTasks = { ...tasks };
    if (newTasks[dateKey]) {
      newTasks[dateKey] = newTasks[dateKey].map(t => 
        t.id === taskId ? { ...t, completed: !t.completed } : t
      );
    }
    setTasks(newTasks);
    setIsSaving(true);

    // 2. Save to Firestore
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_data', 'study_plan');
    try {
        await setDoc(docRef, { tasks: newTasks }, { merge: true });
        // Saving indicator logic handled by effect slightly, or just timeout
        setTimeout(() => setIsSaving(false), 800);
    } catch (e) {
        console.error("Save failed", e);
        setIsSaving(false);
    }
  };

  const getDayStatus = (dateKey) => {
    const dayTasks = tasks[dateKey] || [];
    if (dayTasks.length === 0) return 'empty';
    const completed = dayTasks.filter(t => t.completed).length;
    if (completed === dayTasks.length) return 'complete';
    if (completed > 0) return 'partial';
    return 'none';
  };

  const calculateProgress = () => {
    let total = 0;
    let completed = 0;
    Object.values(tasks).forEach(dayList => {
      dayList.forEach(t => {
        total++;
        if (t.completed) completed++;
      });
    });
    return total === 0 ? 0 : Math.round((completed / total) * 100);
  };

  const getAllTasksList = () => {
    const all = [];
    Object.keys(tasks).sort().forEach(date => {
        tasks[date].forEach(task => {
            all.push({ ...task, date });
        });
    });
    return all;
  };

  const formatDateKey = (date) => {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  };

  const renderCalendar = () => {
    const year = viewMonth.getFullYear();
    const month = viewMonth.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    
    const totalSlots = Math.ceil((daysInMonth + firstDay) / 7) * 7;
    const calendarDays = [];

    for (let i = 0; i < totalSlots; i++) {
      if (i < firstDay || i >= firstDay + daysInMonth) {
        calendarDays.push(<div key={`empty-${i}`} className="h-24 bg-gray-50/50 border border-gray-100/50"></div>);
      } else {
        const day = i - firstDay + 1;
        const currentDayDate = new Date(year, month, day);
        const dateKey = formatDateKey(currentDayDate);
        const dayTasks = tasks[dateKey] || [];
        const isSelected = formatDateKey(selectedDate) === dateKey;
        const isToday = formatDateKey(currentDate) === dateKey;
        
        let type = dayTasks.length > 0 ? dayTasks[0].type : 'normal';
        let bgClass = "bg-white";
        let badgeColor = "text-gray-500";
        
        if (type === 'weakness') { bgClass = "bg-orange-50/30"; badgeColor = "text-orange-600"; }
        else if (type === 'rest') { bgClass = "bg-red-50/30"; badgeColor = "text-red-500"; }
        else if (type === 'exam_prep') { bgClass = "bg-blue-50/30"; badgeColor = "text-blue-600"; }
        else if (type === 'final') { bgClass = "bg-purple-50/30"; badgeColor = "text-purple-600"; }
        else if (type === 'dday') { bgClass = "bg-yellow-50/50 ring-1 ring-yellow-200"; badgeColor = "text-yellow-700"; }

        const status = getDayStatus(dateKey);
        let statusIcon = null;
        if (dayTasks.length > 0) {
            if (status === 'complete') statusIcon = <CheckCircle className="w-4 h-4 text-green-500" />;
            else if (status === 'partial') statusIcon = <div className="w-2 h-2 rounded-full bg-green-400" />;
            else statusIcon = <div className="w-2 h-2 rounded-full bg-gray-300" />;
        }

        calendarDays.push(
          <div 
            key={dateKey} 
            onClick={() => setSelectedDate(currentDayDate)}
            className={`h-24 p-2 border cursor-pointer transition-all flex flex-col justify-between relative group
              ${bgClass} border-gray-100
              ${isSelected ? 'ring-2 ring-indigo-500 z-10 bg-white shadow-md' : 'hover:bg-gray-50'}
            `}
          >
            <div className="flex justify-between items-start">
              <span className={`text-sm font-medium ${isToday ? 'bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-full' : 'text-gray-700'}`}>
                {day}
              </span>
              {statusIcon}
            </div>
            
            {dayTasks.length > 0 && (
               <div className="mt-1">
                 <div className={`text-[10px] font-bold uppercase mb-0.5 ${badgeColor}`}>
                    {type === 'weakness' ? '취약점' : type === 'exam_prep' ? '기출' : type === 'rest' ? '휴식' : type === 'final' ? '마무리' : type === 'dday' ? 'D-DAY' : '학습'}
                 </div>
                 <div className="text-xs text-gray-500 truncate">
                    {dayTasks[0].text}
                 </div>
                 {dayTasks.length > 1 && (
                     <div className="text-[10px] text-gray-400">+{dayTasks.length - 1} more</div>
                 )}
               </div>
            )}
          </div>
        );
      }
    }
    return calendarDays;
  };

  const CalendarView = () => {
    const selectedDateKey = formatDateKey(selectedDate);
    const dayTasks = tasks[selectedDateKey] || [];

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in duration-500">
        <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div className="p-4 flex justify-between items-center border-b border-gray-100">
            <h2 className="font-bold text-lg text-gray-800 flex items-center gap-2">
              <Calendar className="w-5 h-5 text-gray-500" />
              {viewMonth.getFullYear()}년 {viewMonth.getMonth() + 1}월
            </h2>
            <div className="flex gap-2">
              <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth() - 1))} className="p-1 hover:bg-gray-100 rounded">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth() + 1))} className="p-1 hover:bg-gray-100 rounded">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>
          <div className="grid grid-cols-7 text-center py-2 bg-gray-50 border-b border-gray-100">
            {['일', '월', '화', '수', '목', '금', '토'].map((d, i) => (
              <div key={d} className={`text-xs font-bold ${i === 0 ? 'text-red-500' : 'text-gray-500'}`}>{d}</div>
            ))}
          </div>
          <div className="grid grid-cols-7 border-l border-gray-100 bg-gray-50">
            {renderCalendar()}
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col h-full">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h3 className="font-bold text-gray-800 text-xl">
                    {selectedDate.getMonth() + 1}월 {selectedDate.getDate()}일
                </h3>
                <p className="text-sm text-gray-500">오늘의 학습 목표</p>
              </div>
              <div className="text-xs font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded">
                 {dayTasks.length} TASKS
              </div>
            </div>

            {dayTasks.length > 0 ? (
                <div className="space-y-3 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    {dayTasks.map(task => (
                        <div 
                            key={task.id} 
                            onClick={() => toggleTask(selectedDateKey, task.id)}
                            className={`group p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 flex items-start gap-3
                                ${task.completed 
                                    ? 'bg-gray-50 border-gray-100 opacity-60' 
                                    : 'bg-white border-indigo-50 hover:border-indigo-200 shadow-sm'
                                }
                            `}
                        >
                            <div className={`mt-0.5 w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-colors
                                ${task.completed ? 'bg-indigo-500 border-indigo-500' : 'border-gray-300 group-hover:border-indigo-400'}
                            `}>
                                {task.completed && <CheckCircle className="w-3.5 h-3.5 text-white" />}
                            </div>
                            <span className={`text-sm font-medium leading-relaxed ${task.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                {task.text}
                            </span>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="flex-1 flex flex-col items-center justify-center text-gray-400 pb-10">
                    <Coffee className="w-12 h-12 mb-3 opacity-20" />
                    <p className="text-sm">등록된 할 일이 없습니다.</p>
                </div>
            )}
            
            {dayTasks.length > 0 && dayTasks[0].type === 'weakness' && (
                <div className="mt-4 p-3 bg-orange-50 rounded-lg flex items-start gap-2 text-xs text-orange-800">
                    <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5" />
                    <p><b>집중!</b> 성적이 가장 낮은 취약 파트입니다. 꼼꼼히 체크하세요.</p>
                </div>
            )}
        </div>
      </div>
    );
  };

  const DashboardView = () => {
    const allTasks = getAllTasksList();
    const completedTasks = allTasks.filter(t => t.completed);
    const incompleteTasks = allTasks.filter(t => !t.completed);
    
    const todayStr = formatDateKey(currentDate);
    
    const overdue = incompleteTasks.filter(t => t.date < todayStr);
    const todayTodos = incompleteTasks.filter(t => t.date === todayStr);
    const upcoming = incompleteTasks.filter(t => t.date > todayStr);

    return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
            <div className="grid grid-cols-3 gap-4">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div className="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600">
                        <PieChart className="w-6 h-6" />
                    </div>
                    <div>
                        <p className="text-sm text-gray-500">총 진척률</p>
                        <p className="text-2xl font-bold text-gray-800">{calculateProgress()}%</p>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div className="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center text-green-600">
                        <CheckSquare className="w-6 h-6" />
                    </div>
                    <div>
                        <p className="text-sm text-gray-500">완료한 학습</p>
                        <p className="text-2xl font-bold text-gray-800">{completedTasks.length}개</p>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div className="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center text-red-600">
                        <XSquare className="w-6 h-6" />
                    </div>
                    <div>
                        <p className="text-sm text-gray-500">남은 학습</p>
                        <p className="text-2xl font-bold text-gray-800">{incompleteTasks.length}개</p>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-red-50 border-b border-red-100 flex justify-between items-center">
                        <h3 className="font-bold text-red-800 flex items-center gap-2">
                            <AlertCircle className="w-4 h-4" /> 미완료 (To-Do)
                        </h3>
                        <span className="text-xs bg-white text-red-600 px-2 py-1 rounded font-bold">{incompleteTasks.length}</span>
                    </div>
                    <div className="p-4 h-[500px] overflow-y-auto custom-scrollbar space-y-4">
                        {overdue.length > 0 && (
                            <div>
                                <h4 className="text-xs font-bold text-gray-400 mb-2 uppercase">지난 일정 (보충 필요)</h4>
                                <div className="space-y-2">
                                    {overdue.map((t, i) => (
                                        <div key={i} onClick={() => toggleTask(t.date, t.id)} className="cursor-pointer p-3 bg-gray-50 hover:bg-red-50 rounded-lg border border-gray-100 text-sm text-gray-600 flex gap-2">
                                            <div className="w-1 h-full bg-red-400 rounded-full"></div>
                                            <div className="flex-1">
                                                <div className="text-xs text-red-500 font-bold mb-0.5">{t.date}</div>
                                                {t.text}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                         
                        <div>
                            <h4 className="text-xs font-bold text-indigo-600 mb-2 uppercase mt-2">오늘 할 일</h4>
                             {todayTodos.length > 0 ? (
                                <div className="space-y-2">
                                    {todayTodos.map((t, i) => (
                                        <div key={i} onClick={() => toggleTask(t.date, t.id)} className="cursor-pointer p-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg border border-indigo-100 text-sm text-gray-800 font-medium flex gap-2">
                                            <div className="w-1 h-full bg-indigo-500 rounded-full"></div>
                                            <div className="flex-1">{t.text}</div>
                                        </div>
                                    ))}
                                </div>
                             ) : (
                                <p className="text-sm text-gray-400 italic py-2">오늘 남은 일정이 없습니다!</p>
                             )}
                        </div>

                        <div>
                            <h4 className="text-xs font-bold text-gray-400 mb-2 uppercase mt-4">예정된 일정</h4>
                             <div className="space-y-2">
                                {upcoming.slice(0, 10).map((t, i) => (
                                    <div key={i} onClick={() => toggleTask(t.date, t.id)} className="cursor-pointer p-3 bg-white hover:bg-gray-50 rounded-lg border border-gray-100 text-sm text-gray-600 flex gap-2">
                                        <span className="text-xs text-gray-400 w-20 flex-shrink-0 pt-0.5">{t.date}</span>
                                        <div className="flex-1">{t.text}</div>
                                    </div>
                                ))}
                                {upcoming.length > 10 && <p className="text-xs text-center text-gray-400 mt-2">...외 {upcoming.length - 10}개</p>}
                             </div>
                        </div>
                    </div>
                </div>

                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center">
                        <h3 className="font-bold text-green-800 flex items-center gap-2">
                            <CheckCircle className="w-4 h-4" /> 완료 (Done)
                        </h3>
                        <span className="text-xs bg-white text-green-600 px-2 py-1 rounded font-bold">{completedTasks.length}</span>
                    </div>
                    <div className="p-4 h-[500px] overflow-y-auto custom-scrollbar">
                        {completedTasks.length > 0 ? (
                            <div className="space-y-2">
                                {completedTasks.map((t, i) => (
                                    <div key={i} onClick={() => toggleTask(t.date, t.id)} className="cursor-pointer p-3 bg-gray-50 hover:bg-gray-100 opacity-70 rounded-lg border border-gray-100 text-sm text-gray-500 flex gap-2 items-center">
                                         <CheckCircle className="w-4 h-4 text-green-500 flex-shrink-0" />
                                         <div className="flex-1 line-through decoration-gray-400">
                                            <span className="text-xs text-gray-400 mr-2">[{t.date}]</span>
                                            {t.text}
                                         </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                <List className="w-12 h-12 mb-2 opacity-20" />
                                <p>아직 완료한 항목이 없습니다.<br/>하나씩 시작해보세요!</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
  };

  const calculateDday = () => {
    const simToday = new Date(2026, 1, 10);
    const diff = examDate - simToday;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  return (
    <div className="max-w-5xl mx-auto p-4 bg-gray-50 min-h-screen font-sans text-slate-800">
      <div className="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
              <Award className="text-indigo-600" />
              국제무역사 1급 합격 플래너
            </h1>
            <p className="text-gray-500 mt-1 ml-8 flex items-center gap-2">
              목표 시험일: 2026년 3월 28일
              {isSaving && (
                 <span className="text-xs text-green-600 flex items-center gap-1 animate-pulse font-medium bg-green-50 px-2 py-0.5 rounded-full">
                    <Cloud className="w-3 h-3" /> 저장 중...
                 </span>
              )}
            </p>
          </div>
          <div className="flex items-center gap-3">
             <div className="bg-red-50 px-5 py-2 rounded-xl text-center ring-2 ring-red-100">
                <p className="text-xs text-red-500 font-bold uppercase">D-Day</p>
                <p className="text-red-600 font-bold text-2xl">D-{calculateDday()}</p>
             </div>
          </div>
        </div>

        <div className="flex gap-4 mt-8 border-b border-gray-100">
            <button 
                onClick={() => setActiveTab('calendar')}
                className={`pb-3 px-1 flex items-center gap-2 text-sm font-bold transition-all relative
                    ${activeTab === 'calendar' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}
                `}
            >
                <Calendar className="w-4 h-4" />
                월간 달력 & 학습
                {activeTab === 'calendar' && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-indigo-600 rounded-t-full"></div>}
            </button>
            <button 
                onClick={() => setActiveTab('dashboard')}
                className={`pb-3 px-1 flex items-center gap-2 text-sm font-bold transition-all relative
                    ${activeTab === 'dashboard' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}
                `}
            >
                <TrendingUp className="w-4 h-4" />
                현황판 (완료/미완료)
                {activeTab === 'dashboard' && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-indigo-600 rounded-t-full"></div>}
            </button>
        </div>
      </div>

      {activeTab === 'calendar' ? <CalendarView /> : <DashboardView />}
      
    </div>
  );
};

export default StudyPlanner;
